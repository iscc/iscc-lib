# mise.toml — task runner and tool versions for iscc-lib
#
# Usage: mise run <task>

# --- CID (Continuous Iterative Development) ---

[tasks."cid:run"]
description = "Run CID loop until done or max iterations (default: 20)"
run = "uv run tools/cid.py --skip-permissions run --max-iterations {{arg(name='n', i=0, default='20')}} --pause {{arg(name='pause', i=1, default='1200')}}"

[tasks."cid:step"]
description = "Run one full CID iteration (update-state → define-next → advance → review)"
run = "uv run tools/cid.py --skip-permissions step"

[tasks."cid:status"]
description = "Show current project state from state.md"
run = "uv run tools/cid.py status"

[tasks."cid:stats"]
description = "Show iteration log summary statistics"
run = "uv run tools/cid.py stats"

[tasks."cid:orchestrate"]
description = "CID loop using orchestrator agent (one session per iteration)"
run = "uv run tools/cid.py --skip-permissions orchestrate --max-iterations {{arg(name='n', i=0, default='20')}} --pause {{arg(name='pause', i=1, default='1200')}}"

[tasks."cid:state"]
description = "Run update-state agent only"
run = "uv run tools/cid.py --skip-permissions role update-state"

[tasks."cid:next"]
description = "Run define-next agent only"
run = "uv run tools/cid.py --skip-permissions role define-next"

[tasks."cid:advance"]
description = "Run advance agent only"
run = "uv run tools/cid.py --skip-permissions role advance"

[tasks."cid:review"]
description = "Run review agent only"
run = "uv run tools/cid.py --skip-permissions role review"

# --- PR ---

[tasks."pr:main"]
description = "Create a PR from develop to main"
run = "gh pr create -B main -H develop --title '{{arg(name=\"title\", i=0, default=\"Merge develop into main\")}}' --body '{{arg(name=\"body\", i=1, default=\"Merge CID loop progress from develop into main.\")}}'"

# --- Quality ---

[tasks.check]
description = "Run all pre-commit hooks on all files"
run = "uv run prek run --all-files"

[tasks.lint]
description = "Run format checks, clippy, and ruff"
run = """
cargo fmt --all --check &&
cargo clippy --workspace --all-targets -- -D warnings &&
uv run ruff check &&
uv run ruff format --check
"""

[tasks.format]
description = "Run pre-commit auto-fix hooks (quiet, filtered output)"
run = "uv run prek run --stage pre-commit --all-files -q 2>&1 || true"

[tasks.test]
description = "Run all tests"
run = """
cargo test --workspace &&
uv run pytest
"""

# --- Release verification ---

[tasks."test:install"]
description = "Test published packages are installable from registries"
run = "uv run scripts/test_install.py {{arg(name='flags', i=0, default='--version 0.0.2')}}"

# --- Version ---

[tasks."version:sync"]
description = "Sync non-Cargo manifest versions with workspace version"
run = "uv run scripts/version_sync.py"

[tasks."version:check"]
description = "Check that all manifest versions match workspace version"
run = "uv run scripts/version_sync.py --check"
